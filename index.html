<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeachTime - Forecast</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        
        .location-input-group {
            display: none;
            gap: 10px;
            margin-bottom: 30px;
        }
        
        #locationInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        #locationInput:focus {
            outline: none;
            border-color: #667eea;
        }
        
        #searchBtn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        #searchBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        
        #searchBtn:active {
            transform: translateY(0);
        }
        
        .data-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }
        
        .day-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        
        .day-btn {
            padding: 10px 20px;
            background: #f0f0f0;
            color: #333;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 0.95em;
        }
        
        .day-btn:hover {
            background: #e0e0e0;
        }
        
        .day-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
        }
        
        .weather-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .weather-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .weather-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }
        
        .weather-card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
        }
        
        .weather-metric {
            margin: 10px 0;
            color: #555;
            font-size: 0.95em;
        }
        
        .weather-metric strong {
            color: #333;
        }
        
        .loading {
            text-align: center;
            color: #666;
            font-size: 1.1em;
        }
        
        .error {
            color: #d32f2f;
            text-align: center;
            font-size: 1.1em;
        }
        
        @media (max-width: 600px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .location-input-group {
                flex-direction: column;
            }
            
            .weather-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèñÔ∏è BeachTime</h1>
        <p class="subtitle">Your beach weather forecast</p>
        
        <div class="location-input-group">
            <input type="text" id="locationInput" placeholder="Enter a location (e.g., 'Swanbourne Beach, Western Australia')" />
            <button id="searchBtn">Search</button>
        </div>
        
        <div class="data-warning" id="dataWarning"></div>
        
        <div id="daySelector" class="day-selector" id="globalDaySelector"></div>
        
        <div id="weatherDisplay">
            <p class="loading">Loading weather data...</p>
        </div>
    </div>

    <script>
        // Global variables
        var currentLocation = null;
        var currentDay = 0;
        var weatherData = [];
        var uniqueDates = [];
        
        // Default location: Swanbourne Beach, Western Australia
        var DEFAULT_LATITUDE = -31.9688;
        var DEFAULT_LONGITUDE = 115.7673;

        // Initialize
        document.getElementById('searchBtn').addEventListener('click', searchLocation);
        document.getElementById('locationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchLocation();
        });

        // Auto-load with default location (Swanbourne Beach, Western Australia)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadDefaultLocation);
        } else {
            loadDefaultLocation();
        }

        function loadDefaultLocation() {
            showLoading();
            hideDataWarning();
            
            currentLocation = {
                name: 'Swanbourne Beach',
                admin1: 'Western Australia',
                country: 'Australia',
                latitude: DEFAULT_LATITUDE,
                longitude: DEFAULT_LONGITUDE
            };
            
            document.title = 'Swanbourne Beach, Western Australia, Australia - BeachTime';
            getWeatherData(DEFAULT_LATITUDE, DEFAULT_LONGITUDE);
        }

        function showDataWarning(message) {
            var warningElement = document.getElementById('dataWarning');
            warningElement.textContent = message;
            warningElement.style.display = 'block';
        }

        function hideDataWarning() {
            document.getElementById('dataWarning').style.display = 'none';
        }

        function searchLocation() {
            var location = document.getElementById('locationInput').value.trim();
            if (!location) {
                showDataWarning('Please enter a location');
                return;
            }

            showLoading();
            hideDataWarning();

            // Geocode the location
            fetch('https://geocoding-api.open-meteo.com/v1/search?name=' + encodeURIComponent(location) + '&count=1&language=en&format=json')
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    if (!data.results || data.results.length === 0) {
                        showDataWarning('Location not found. Please try another search.');
                        showError('Location not found');
                        return;
                    }

                    var result = data.results[0];
                    currentLocation = result;
                    var displayName = result.name + (result.admin1 ? ', ' + result.admin1 : '') + (result.country ? ', ' + result.country : '');
                    document.title = displayName + ' - BeachTime';

                    // Get weather data
                    getWeatherData(result.latitude, result.longitude);
                })
                .catch(function(error) {
                    console.error('Error:', error);
                    showDataWarning('Error searching for location. Please try again.');
                    showError('Search error');
                });
        }

        function getWeatherData(latitude, longitude) {
            // Fetch weather data - using fixed Swanbourne Beach coordinates
            var weatherUrl = 'https://api.open-meteo.com/v1/forecast?latitude=-31.9688&longitude=115.7673&hourly=wind_speed_10m,temperature_2m&timezone=Asia%2FSingapore';
            
            // Fetch marine data - using fixed Swanbourne Beach coordinates
            var marineUrl = 'https://marine-api.open-meteo.com/v1/marine?latitude=-31.9688&longitude=115.7673&hourly=sea_surface_temperature&timezone=Asia%2FSingapore';

            Promise.all([
                fetch(weatherUrl).then(function(r) { return r.json(); }),
                fetch(marineUrl).then(function(r) { return r.json(); })
            ])
            .then(function(results) {
                var weatherData = results[0];
                var marineData = results[1];
                processWeatherData(weatherData, marineData);
                updateDayButtons();
                displayWeather();
            })
            .catch(function(error) {
                console.error('Error fetching data:', error);
                showDataWarning('Error fetching weather data. Please try again.');
                showError('Data fetch error');
            });
        }

        function showLoading() {
            document.getElementById('weatherDisplay').innerHTML = '<p class="loading">Loading...</p>';
        }

        function showError(message) {
            document.getElementById('weatherDisplay').innerHTML = '<p class="error">' + message + '</p>';
        }

        function processWeatherData(data, marineData) {
            // Validate API response structure
            if (!data || !data.hourly || !data.hourly.time || !data.hourly.temperature_2m || !data.hourly.wind_speed_10m) {
                console.error('Invalid API response structure');
                showDataWarning('Invalid data format received from API');
                return;
            }
            
            var hourly = data.hourly;
            var times = hourly.time;
            var temperatures = hourly.temperature_2m;
            var windSpeeds = hourly.wind_speed_10m;
            
            // Extract unique dates from the data
            var uniqueDateSet = new Set();
            for (var i = 0; i < times.length; i++) {
                var dateKey = times[i].split('T')[0];
                uniqueDateSet.add(dateKey);
            }
            var allDates = Array.from(uniqueDateSet).sort();
            
            // Process marine data if available, but don't fail if it's invalid
            var marineTimes = null;
            var seaTemperatures = null;
            
            if (marineData && marineData.hourly && marineData.hourly.time && marineData.hourly.sea_surface_temperature) {
                marineTimes = marineData.hourly.time;
                seaTemperatures = marineData.hourly.sea_surface_temperature;
            } else {
                console.warn('Marine data not available, will use estimated water temperatures');
            }
            
            // Validate that temperature and wind data are arrays with values
            if (!Array.isArray(temperatures) || !Array.isArray(windSpeeds) || 
                temperatures.length === 0 || windSpeeds.length === 0) {
                console.error('Temperature or wind data is missing or invalid');
                showDataWarning('Temperature or wind data is missing from API response');
                return;
            }
            
            // Check for invalid data (null, undefined, or non-numeric values)
            var hasInvalidTemp = temperatures.some(function(t) { return t == null || typeof t !== 'number' || isNaN(t); });
            var hasInvalidWind = windSpeeds.some(function(w) { return w == null || typeof w !== 'number' || isNaN(w); });
            
            if (hasInvalidTemp || hasInvalidWind) {
                console.error('Temperature or wind data contains invalid values');
                showDataWarning('Temperature or wind data contains invalid values');
                return;
            }
            
            // Create a map of marine data for easy lookup with fuzzy matching
            var marineDataMap = {};
            if (marineTimes && seaTemperatures) {
                // Validate seaTemperatures contains only valid numbers
                var hasInvalidSeaTemp = seaTemperatures.some(function(t) { return t == null || typeof t !== 'number' || isNaN(t); });
                
                if (hasInvalidSeaTemp) {
                    console.warn('Sea temperature data contains invalid values, will use estimated water temperatures');
                } else {
                    for (var i = 0; i < marineTimes.length; i++) {
                        var marineTime = new Date(marineTimes[i]).getTime();
                        marineDataMap[marineTimes[i]] = {
                            timestamp: marineTime,
                            temperature: seaTemperatures[i]
                        };
                    }
                }
            }
            
            // Group data by day - dates come directly from the data, not from offsets
            var dayMap = {};
            
            for (var i = 0; i < times.length; i++) {
                var dateTime = new Date(times[i]);
                var dateKey = dateTime.toISOString().split('T')[0];
                var hour = dateTime.getHours();
                
                // Only include hours from 7am to 7pm
                if (hour >= 7 && hour <= 19) {
                    if (!dayMap[dateKey]) {
                        dayMap[dateKey] = {
                            date: dateKey,
                            hours: [],
                            temp: [],
                            wind: [],
                            water: []
                        };
                    }
                    
                    dayMap[dateKey].hours.push(hour);
                    dayMap[dateKey].temp.push(Math.round(temperatures[i]));
                    dayMap[dateKey].wind.push(Math.round(windSpeeds[i]));
                    
                    // Get water temperature from marine API with fuzzy matching or estimate if not available
                    var waterTemp = null;
                    var ONE_HOUR_MS = 60 * 60 * 1000; // 1 hour in milliseconds
                    
                    if (Object.keys(marineDataMap).length > 0) {
                        var currentTime = new Date(times[i]).getTime();
                        var exactMatch = marineDataMap[times[i]];
                        
                        if (exactMatch) {
                            waterTemp = exactMatch.temperature;
                        } else {
                            // Find nearest time within 1 hour tolerance
                            var closestTime = null;
                            var minDiff = Infinity;
                            
                            for (var marineKey in marineDataMap) {
                                var timeDiff = Math.abs(marineDataMap[marineKey].timestamp - currentTime);
                                if (timeDiff < minDiff) {
                                    minDiff = timeDiff;
                                    closestTime = marineKey;
                                }
                            }
                            
                            // Only use the closest match if it's within 1 hour tolerance
                            if (closestTime && minDiff <= ONE_HOUR_MS) {
                                waterTemp = marineDataMap[closestTime].temperature;
                            }
                        }
                    }
                    
                    // Using != null to check for both null and undefined
                    if (waterTemp != null && typeof waterTemp === 'number' && !isNaN(waterTemp)) {
                        dayMap[dateKey].water.push(Math.round(waterTemp * 10) / 10);
                    } else {
                        // Fallback to estimate
                        dayMap[dateKey].water.push(Math.round((temperatures[i] - 2.5) * 10) / 10);
                    }
                }
            }
            
            // Convert to array and validate we have data
            weatherData = Object.values(dayMap);
            
            // Sort weatherData by date to ensure chronological order
            weatherData.sort(function(a, b) {
                return new Date(a.date) - new Date(b.date);
            });
            
            if (weatherData.length === 0) {
                console.error('No valid weather data found in the expected time range');
                showDataWarning('No weather data available for the selected time period');
                return;
            }
        }

        function updateDayButtons() {
            var daySelector = document.getElementById('daySelector');
            daySelector.innerHTML = '';
            
            // Create buttons for ALL days in weatherData
            for (var i = 0; i < weatherData.length; i++) {
                var btn = document.createElement('button');
                btn.className = 'day-btn' + (i === currentDay ? ' active' : '');
                btn.setAttribute('data-day', i);
                
                var dateObj = new Date(weatherData[i].date + 'T00:00:00');
                var monthDay = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                btn.textContent = monthDay;
                daySelector.appendChild(btn);
            }
            
            // Add event listeners to day buttons
            var dayButtons = daySelector.getElementsByClassName('day-btn');
            for (var i = 0; i < dayButtons.length; i++) {
                dayButtons[i].addEventListener('click', function() {
                    currentDay = parseInt(this.getAttribute('data-day'));
                    updateDayButtons();
                    displayWeather();
                });
            }
        }

        function displayWeather() {
            if (!weatherData || weatherData.length === 0) {
                showError('No weather data available');
                return;
            }

            var currentData = weatherData[currentDay];
            var display = document.getElementById('weatherDisplay');

            var avgTemp = Math.round(currentData.temp.reduce(function(a, b) { return a + b; }) / currentData.temp.length);
            var maxTemp = Math.max.apply(null, currentData.temp);
            var minTemp = Math.min.apply(null, currentData.temp);

            var avgWind = Math.round(currentData.wind.reduce(function(a, b) { return a + b; }) / currentData.wind.length);
            var maxWind = Math.max.apply(null, currentData.wind);

            var avgWater = (currentData.water.reduce(function(a, b) { return a + b; }) / currentData.water.length).toFixed(1);
            var maxWater = Math.max.apply(null, currentData.water);
            var minWater = Math.min.apply(null, currentData.water);

            display.innerHTML = 
                '<div class="weather-grid">' +
                    '<div class="weather-card">' +
                        '<h3>üå°Ô∏è Temperature</h3>' +
                        '<div class="weather-metric"><strong>Average:</strong> ' + avgTemp + '¬∞C</div>' +
                        '<div class="weather-metric"><strong>High:</strong> ' + maxTemp + '¬∞C</div>' +
                        '<div class="weather-metric"><strong>Low:</strong> ' + minTemp + '¬∞C</div>' +
                    '</div>' +
                    '<div class="weather-card">' +
                        '<h3>üí® Wind Speed</h3>' +
                        '<div class="weather-metric"><strong>Average:</strong> ' + avgWind + ' km/h</div>' +
                        '<div class="weather-metric"><strong>Max:</strong> ' + maxWind + ' km/h</div>' +
                    '</div>' +
                    '<div class="weather-card">' +
                        '<h3>üåä Water Temperature</h3>' +
                        '<div class="weather-metric"><strong>Average:</strong> ' + avgWater + '¬∞C</div>' +
                        '<div class="weather-metric"><strong>High:</strong> ' + maxWater + '¬∞C</div>' +
                        '<div class="weather-metric"><strong>Low:</strong> ' + minWater + '¬∞C</div>' +
                    '</div>' +
                '</div>';
        }
    </script>
</body>
</html>
